# 微信小程序培训管理系统 - 详细部署操作手册

## 📋 部署前准备清单

在开始部署之前，请确保准备好以下内容：

- [ ] 微信小程序账号（已注册并完成企业认证）
- [ ] 微信开发者工具（已安装）
- [ ] 项目 AppID
- [ ] 管理员微信号
- [ ] 体检表模板文件（Word格式）

---

## 第一阶段：环境准备

### 步骤 1：注册微信小程序账号

**操作步骤**：
1. 访问 https://mp.weixin.qq.com/
2. 点击右上角"立即注册"
3. 选择"小程序"类型
4. 填写账号信息：
   - 邮箱（用于接收验证码）
   - 密码
   - 验证码
5. 邮箱验证
6. 选择主体类型：**企业**
7. 填写企业信息：
   - 企业名称
   - 营业执照注册号
   - 企业对公账户信息
8. 管理员信息验证（微信扫码）
9. 完成注册

**注意事项**：
- 企业认证需要300元/年
- 认证需要1-3个工作日
- 保存好登录邮箱和密码

**获取 AppID**：
1. 登录微信公众平台
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 复制 AppID（格式：wx开头的字符串）

---

### 步骤 2：安装微信开发者工具

**操作步骤**：
1. 访问 https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 根据操作系统下载对应版本：
   - Windows 64位
   - Windows 32位
   - macOS
3. 安装开发者工具
4. 打开开发者工具
5. 使用管理员微信扫码登录

**验证安装**：
- 打开开发者工具
- 能看到"小程序"、"小游戏"等选项
- 能正常扫码登录

---

## 第二阶段：项目配置

### 步骤 3：配置项目 AppID

**操作步骤**：

1. 打开项目文件 `project.config.json`
2. 找到 `appid` 字段
3. 替换为你的 AppID：

```json
{
  "appid": "wxYOUR_APPID_HERE",  // 替换这里
  "projectname": "training-miniprogram"
}
```

4. 保存文件

**示例**：
```json
{
  "appid": "wx1234567890abcdef",
  "projectname": "training-miniprogram"
}
```

---

### 步骤 4：在微信开发者工具中打开项目

**操作步骤**：

1. 打开微信开发者工具
2. 点击"+"或"导入项目"
3. 填写项目信息：
   - **项目名称**：培训管理系统
   - **目录**：选择 `training-miniprogram` 文件夹
   - **AppID**：选择"使用已有AppID"，输入你的AppID
   - **开发模式**：小程序
   - **后端服务**：微信云开发
4. 点击"导入"

**验证**：
- 项目能正常打开
- 左侧显示项目文件结构
- 右侧显示模拟器预览

---

## 第三阶段：云开发配置

### 步骤 5：开通云开发

**操作步骤**：

1. 在微信开发者工具中，点击顶部工具栏的"云开发"按钮
2. 首次使用会提示"开通云开发"
3. 点击"开通"
4. 填写环境信息：
   - **环境名称**：training-prod（生产环境）
   - **环境ID**：自动生成（记录下来，格式：training-prod-xxxxx）
5. 点击"创建"
6. 等待环境初始化（约2-3分钟）

**记录环境ID**：
- 环境ID格式：`training-prod-xxxxx`
- 将此ID记录下来，后续需要使用

---

### 步骤 6：配置云开发环境ID

**操作步骤**：

1. 打开项目文件 `app.js`
2. 找到云开发初始化代码
3. 替换环境ID：

```javascript
wx.cloud.init({
  env: 'training-prod-xxxxx', // 替换为你的环境ID
  traceUser: true
})
```

4. 保存文件

**示例**：
```javascript
wx.cloud.init({
  env: 'training-prod-2g9kf',  // 实际的环境ID
  traceUser: true
})
```

---

### 步骤 7：创建云数据库集合

**操作步骤**：

1. 在微信开发者工具中，点击"云开发"按钮
2. 进入云开发控制台
3. 点击左侧"数据库"标签
4. 点击"添加集合"

**创建 students 集合**：
1. 集合名称：`students`
2. 点击"确定"

**创建 admins 集合**：
1. 点击"添加集合"
2. 集合名称：`admins`
3. 点击"确定"

**创建 config 集合**：
1. 点击"添加集合"
2. 集合名称：`config`
3. 点击"确定"

**验证**：
- 数据库中应该有3个集合：students、admins、config

---

### 步骤 8：配置数据库索引

**操作步骤**：

1. 在云开发控制台，点击"数据库"
2. 点击 `students` 集合
3. 点击"索引管理"标签
4. 点击"添加索引"

**为 students 集合添加索引**：

**索引1：_openid**
- 字段名：`_openid`
- 索引类型：升序
- 点击"确定"

**索引2：status**
- 字段名：`status`
- 索引类型：升序
- 点击"确定"

**索引3：training_type**
- 字段名：`training_type`
- 索引类型：升序
- 点击"确定"

**索引4：company**
- 字段名：`company`
- 索引类型：升序
- 点击"确定"

**索引5：created_at**
- 字段名：`created_at`
- 索引类型：降序
- 点击"确定"

**索引6：复合索引**
- 点击"添加索引"
- 选择"复合索引"
- 添加字段：
  - `status` (升序)
  - `training_type` (升序)
  - `created_at` (降序)
- 点击"确定"

---

### 步骤 9：配置数据库权限

**操作步骤**：

1. 在云开发控制台，点击"数据库"
2. 点击 `students` 集合
3. 点击"权限设置"标签
4. 选择"自定义安全规则"
5. 输入以下规则：

```json
{
  "read": "auth.openid != null",
  "write": "auth.openid != null"
}
```

6. 点击"保存"

**为 admins 集合配置权限**：
1. 点击 `admins` 集合
2. 点击"权限设置"
3. 选择"自定义安全规则"
4. 输入：

```json
{
  "read": true,
  "write": false
}
```

5. 点击"保存"

**为 config 集合配置权限**：
1. 点击 `config` 集合
2. 点击"权限设置"
3. 选择"自定义安全规则"
4. 输入：

```json
{
  "read": true,
  "write": false
}
```

5. 点击"保存"

---

### 步骤 10：导入配置数据

**操作步骤**：

1. 在云开发控制台，点击"数据库"
2. 点击 `config` 集合
3. 点击"添加记录"
4. 切换到"导入"标签
5. 选择"JSON"格式
6. 复制以下内容并粘贴：

```json
{
  "_id": "job_categories",
  "data": {
    "special_operation": {
      "name": "特种作业",
      "attachments": ["diploma", "id_card_front", "id_card_back"],
      "job_categories": [
        {
          "name": "电工作业",
          "exam_projects": [
            {"name": "低压电工作业", "code": ""},
            {"name": "高压电工作业", "code": ""},
            {"name": "电力电缆作业", "code": ""},
            {"name": "电气试验作业", "code": ""},
            {"name": "继电保护作业", "code": ""},
            {"name": "防爆电气作业", "code": ""}
          ]
        },
        {
          "name": "焊接与热切割作业",
          "exam_projects": [
            {"name": "熔化焊接与热切割作业", "code": ""}
          ]
        },
        {
          "name": "高处作业",
          "exam_projects": [
            {"name": "登高架设作业", "code": ""},
            {"name": "高处安装、维护、拆除作业", "code": ""}
          ]
        }
      ]
    },
    "special_equipment": {
      "name": "特种设备",
      "attachments": ["photo", "diploma", "id_card_front", "id_card_back", "hukou_residence", "hukou_personal"],
      "job_categories": [
        {
          "name": "特种设备安全管理",
          "exam_projects": [
            {"name": "电梯管理", "code": "A"},
            {"name": "场（厂）内专用机动车辆安全管理", "code": "A"},
            {"name": "起重机械管理", "code": "A"},
            {"name": "锅炉压力容器压力管道", "code": "A"},
            {"name": "特种设备安全管理", "code": "A"}
          ]
        },
        {
          "name": "锅炉作业",
          "exam_projects": [
            {"name": "工业锅炉司炉", "code": "G1"},
            {"name": "锅炉水处理", "code": "G3"}
          ]
        },
        {
          "name": "压力容器作业",
          "exam_projects": [
            {"name": "快开门式压力容器操作", "code": "R1"}
          ]
        },
        {
          "name": "起重机作业",
          "exam_projects": [
            {"name": "起重机指挥", "code": "Q1"},
            {"name": "桥式起重机司机", "code": "Q2"}
          ]
        },
        {
          "name": "场(厂)内专用机动车辆作业",
          "exam_projects": [
            {"name": "叉车司机", "code": "N1"},
            {"name": "观光车和观光列车司机", "code": "N2"}
          ]
        }
      ]
    }
  }
}
```

7. 点击"确定"

**验证**：
- config 集合中应该有1条记录
- _id 为 "job_categories"

---

## 第四阶段：云函数部署

### 步骤 11：安装云函数依赖

**操作步骤**：

**方式一：在微信开发者工具中安装（推荐）**

1. 在微信开发者工具中，右键点击 `cloudfunctions` 目录
2. 选择"上传并部署：云端安装依赖（全部云函数）"
3. 等待部署完成（约3-5分钟）

**方式二：手动安装依赖（可选）**

如果方式一失败，可以手动安装：

```bash
# 进入项目目录
cd /Users/Ditto/Documents/jingjipeixun/training-miniprogram

# 为每个云函数安装依赖
cd cloudfunctions/exportExcel && npm install && cd ../..
cd cloudfunctions/generateHealthCheck && npm install && cd ../..
cd cloudfunctions/downloadAttachments && npm install && cd ../..
```

---

### 步骤 12：上传云函数

**操作步骤**：

1. 在微信开发者工具中，展开 `cloudfunctions` 目录
2. 右键点击 `cloudfunctions` 目录
3. 选择"上传并部署：云端安装依赖（全部云函数）"
4. 等待上传完成

**验证云函数部署**：
1. 点击"云开发"按钮
2. 进入云开发控制台
3. 点击左侧"云函数"标签
4. 应该看到12个云函数：
   - login
   - submitStudent
   - getStudents
   - getStudentDetail
   - reviewStudent
   - getCompanies
   - batchReview
   - updateStudent
   - deleteStudent
   - exportExcel
   - generateHealthCheck
   - downloadAttachments

5. 每个云函数的状态应该是"部署成功"

---

### 步骤 13：测试云函数

**操作步骤**：

1. 在云开发控制台，点击"云函数"
2. 点击 `login` 云函数
3. 点击"测试"标签
4. 点击"运行测试"
5. 查看返回结果，应该包含 openid

**示例返回**：
```json
{
  "openid": "oXXXX-xxxxxxxxxxxxxxxxx",
  "isAdmin": false,
  "role": "user"
}
```

---

## 第五阶段：云存储配置

### 步骤 14：创建云存储目录

**操作步骤**：

1. 在云开发控制台，点击"云存储"
2. 点击"上传文件"
3. 创建以下目录结构（通过上传文件到对应目录）：

**创建 students 目录**：
- 点击"新建文件夹"
- 文件夹名：`students`

**创建 students/special_operation 目录**：
- 进入 students 目录
- 点击"新建文件夹"
- 文件夹名：`special_operation`

**创建 students/special_equipment 目录**：
- 返回 students 目录
- 点击"新建文件夹"
- 文件夹名：`special_equipment`

**创建其他目录**：
- 返回根目录
- 创建 `exports` 目录
- 创建 `temp` 目录
- 创建 `templates` 目录

---

### 步骤 15：上传体检表模板

**准备模板文件**：

1. 准备两个Word文档：
   - 叉车司机体检表.docx
   - 锅炉水处理体检表.docx

2. 在模板中使用以下占位符：
   - `{name}` - 姓名
   - `{gender}` - 性别
   - `{id_card}` - 身份证号
   - `{phone}` - 手机号
   - `{company}` - 单位名称
   - `{date}` - 日期

**上传模板**：

1. 在云开发控制台，点击"云存储"
2. 进入 `templates` 目录
3. 点击"上传文件"
4. 选择"叉车司机体检表.docx"
5. 点击"确定"
6. 重复步骤3-5，上传"锅炉水处理体检表.docx"

**验证**：
- templates 目录中应该有2个文件

---

## 第六阶段：管理员配置

### 步骤 16：获取管理员 openid

**方法一：使用调试页面**

1. 在微信开发者工具中，点击"编译"
2. 在模拟器中，打开小程序
3. 打开调试器（Console标签）
4. 查看登录日志，找到 openid
5. 复制 openid（格式：oXXXX-xxxxxxxxxxxxxxxxx）

**方法二：查看云函数日志**

1. 在云开发控制台，点击"云函数"
2. 点击 `login` 云函数
3. 点击"日志"标签
4. 查看最近的调用日志
5. 找到返回的 openid

---

### 步骤 17：添加管理员到数据库

**操作步骤**：

1. 在云开发控制台，点击"数据库"
2. 点击 `admins` 集合
3. 点击"添加记录"
4. 输入以下内容（替换 openid）：

```json
{
  "openid": "oXXXX-你的管理员openid",
  "name": "管理员姓名",
  "role": "admin",
  "is_active": true
}
```

5. 点击"确定"

**示例**：
```json
{
  "openid": "oXXXX-abc123def456",
  "name": "张三",
  "role": "admin",
  "is_active": true
}
```

**验证**：
- admins 集合中应该有1条记录
- 重新打开小程序，应该能看到"审核管理"标签

---

## 第七阶段：测试

### 步骤 18：本地测试

**测试用户功能**：

1. 在微信开发者工具中，点击"编译"
2. 在模拟器中测试以下功能：
   - [ ] 打开小程序，自动登录
   - [ ] 进入"信息采集"页面
   - [ ] 选择培训类型
   - [ ] 填写学员信息
   - [ ] 上传附件（可以使用测试图片）
   - [ ] 点击"提交所有信息"
   - [ ] 查看"我的提交"列表
   - [ ] 点击查看详情

**测试管理员功能**：

1. 确保已添加管理员账号
2. 重新编译小程序
3. 测试以下功能：
   - [ ] 自动跳转到"审核管理"页面
   - [ ] 查看学员列表
   - [ ] 使用筛选功能
   - [ ] 使用搜索功能
   - [ ] 点击学员查看详情
   - [ ] 预览附件
   - [ ] 审核通过/驳回

---

### 步骤 19：真机调试

**操作步骤**：

1. 在微信开发者工具中，点击顶部工具栏的"真机调试"
2. 使用微信扫描二维码
3. 在手机上打开小程序
4. 测试所有功能

**注意事项**：
- 真机调试需要手机和电脑在同一网络
- 测试文件上传功能（拍照、选择相册）
- 测试图片预览功能

---

## 第八阶段：上传和发布

### 步骤 20：上传代码

**操作步骤**：

1. 在微信开发者工具中，点击顶部工具栏的"上传"
2. 填写版本信息：
   - **版本号**：1.0.0
   - **项目备注**：初始版本，包含学员信息采集和管理审核功能
3. 点击"上传"
4. 等待上传完成

**验证**：
- 上传成功后会显示"上传成功"提示
- 可以在微信公众平台查看上传的版本

---

### 步骤 21：设置体验版

**操作步骤**：

1. 登录微信公众平台 https://mp.weixin.qq.com/
2. 进入"版本管理"
3. 在"开发版本"中找到刚上传的版本
4. 点击"选为体验版"
5. 添加体验成员：
   - 点击"体验成员管理"
   - 点击"添加成员"
   - 输入微信号
   - 点击"确定"

**测试体验版**：
- 体验成员在微信中搜索小程序名称
- 可以看到"体验版"标识
- 测试所有功能

---

### 步骤 22：提交审核

**操作步骤**：

1. 在微信公众平台，进入"版本管理"
2. 在"开发版本"中找到要提交的版本
3. 点击"提交审核"
4. 填写审核信息：

**配置功能页面**：
- 点击"添加功能页面"
- 选择"信息采集"页面
- 标签：教育、工具
- 点击"确定"

**填写审核说明**：
```
这是一个培训管理系统小程序，主要功能包括：
1. 学员信息采集：用户可以填写学员信息并上传证件照片
2. 审核管理：管理员可以审核学员提交的信息
3. 数据导出：管理员可以导出学员数据

本小程序使用微信云开发，数据存储在云端，安全可靠。
```

**测试账号**（如果需要）：
- 提供测试用的微信号
- 说明测试流程

5. 点击"提交审核"

**审核时间**：
- 通常1-7个工作日
- 可以在"版本管理"中查看审核进度

---

### 步骤 23：发布正式版

**操作步骤**：

1. 等待审核通过（会收到微信通知）
2. 登录微信公众平台
3. 进入"版本管理"
4. 在"审核版本"中找到审核通过的版本
5. 点击"发布"
6. 确认发布
7. 等待发布完成（约5-10分钟）

**验证**：
- 在微信中搜索小程序名称
- 可以正常打开和使用
- 所有用户都可以访问

---

## 第九阶段：监控和维护

### 步骤 24：配置监控

**操作步骤**：

1. 在微信公众平台，进入"数据分析"
2. 查看以下数据：
   - 用户访问数据
   - 页面访问路径
   - 用户留存率

3. 在云开发控制台，查看：
   - 云函数调用统计
   - 数据库读写统计
   - 云存储使用情况

---

### 步骤 25：定期维护

**每周维护**：
- [ ] 检查云函数错误日志
- [ ] 清理临时文件（temp 和 exports 目录）
- [ ] 检查数据库性能

**每月维护**：
- [ ] 检查云开发资源使用情况
- [ ] 备份重要数据
- [ ] 优化慢查询

---

## 常见问题排查

### 问题1：云函数调用失败

**症状**：小程序提示"云函数调用失败"

**排查步骤**：
1. 检查云函数是否部署成功
2. 查看云函数日志
3. 检查云开发环境ID是否正确
4. 检查网络连接

**解决方案**：
- 重新部署云函数
- 修正环境ID
- 检查权限配置

---

### 问题2：文件上传失败

**症状**：上传文件时提示失败

**排查步骤**：
1. 检查文件大小（不超过10MB）
2. 检查文件格式（JPG/PNG）
3. 检查云存储权限
4. 查看云存储容量

**解决方案**：
- 压缩图片
- 检查权限设置
- 清理不需要的文件

---

### 问题3：管理员权限不生效

**症状**：管理员无法看到审核管理页面

**排查步骤**：
1. 检查 admins 集合中是否有记录
2. 检查 openid 是否正确
3. 检查 is_active 字段是否为 true
4. 重新登录小程序

**解决方案**：
- 重新添加管理员记录
- 确认 openid 正确
- 清除小程序缓存后重新登录

---

## 部署完成检查清单

部署完成后，请确认以下所有项目：

**环境配置**：
- [ ] AppID 已配置
- [ ] 云开发环境ID已配置
- [ ] 云数据库集合已创建（students, admins, config）
- [ ] 数据库索引已配置
- [ ] 数据库权限已配置
- [ ] 配置数据已导入

**云函数**：
- [ ] 12个云函数全部部署成功
- [ ] 云函数测试通过
- [ ] 云函数依赖已安装

**云存储**：
- [ ] 目录结构已创建
- [ ] 体检表模板已上传
- [ ] 存储权限已配置

**管理员**：
- [ ] 管理员 openid 已获取
- [ ] 管理员已添加到数据库
- [ ] 管理员权限测试通过

**测试**：
- [ ] 本地测试通过
- [ ] 真机调试通过
- [ ] 体验版测试通过

**发布**：
- [ ] 代码已上传
- [ ] 审核已通过
- [ ] 正式版已发布

---

## 🎉 恭喜！部署完成！

如果所有检查项都已完成，你的微信小程序培训管理系统已经成功部署并可以正常使用了！

**下一步**：
1. 通知用户开始使用
2. 收集用户反馈
3. 持续优化和改进

**技术支持**：
- 查看项目文档
- 查看代码注释
- 参考微信官方文档

**祝使用愉快！** 🎊
