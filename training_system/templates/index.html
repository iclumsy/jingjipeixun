<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学员信息采集系统</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="/static/images/logo.jpg" alt="Logo" style="height: 60px; width: auto;">
                <div>
                    <h1>学员信息采集系统</h1>
                    <p>阳泉精技特种作业人员培训有限公司</p>
                </div>
            </div>
        </header>

        <form id="collectionForm">
            <div id="students-container">
            </div>

            <div class="actions">
                <button type="button" id="addStudentBtn" class="btn secondary">+ 添加学员</button>
                <button type="submit" id="submitBtn" class="btn primary">提交所有信息</button>
            </div>
        </form>
    </div>

    <template id="student-template">
        <div class="student-entry">
            <div class="entry-header">
                <h3>学员信息</h3>
                <button type="button" class="btn-delete" onclick="removeStudent(this)">×</button>
            </div>
            <div class="form-section">
                <div class="section-title">个人信息</div>
                <div class="form-grid">
                    <div class="form-group w-sm">
                        <label>姓名</label>
                        <span class="hint-slot"></span>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group w-xs">
                        <label>性别</label>
                        <span class="hint-slot"></span>
                        <select name="gender" required>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="form-group w-md">
                        <label>文化程度</label>
                        <span class="hint-slot"></span>
                        <select name="education" required>
                            <option value="">请选择</option>
                            <option value="研究生及以上">研究生及以上</option>
                            <option value="本科或同等学历">本科或同等学历</option>
                            <option value="专科或同等学历">专科或同等学历</option>
                            <option value="中专或同等学历">中专或同等学历</option>
                            <option value="高中或同等学历">高中或同等学历</option>
                            <option value="初中">初中</option>
                        </select>
                    </div>
                    <div class="form-group w-lg">
                        <label>身份证号</label>
                        <span class="hint-slot"></span>
                        <input type="text" name="id_card" required pattern="\d{17}[\dXx]" title="请输入正确的18位身份证号">
                    </div>
                    <div class="form-group w-md">
                        <label>手机号</label>
                        <span class="hint-slot"></span>
                        <input type="tel" name="phone" required pattern="\d{11}" title="请输入11位手机号">
                    </div>
                    <div class="form-row">
                        <div class="form-group w-1-5">
                            <label>毕业院校</label>
                            <span class="hint-slot"></span>
                            <input type="text" name="school">
                        </div>
                        <div class="form-group w-1-5">
                            <label>所学专业</label>
                            <span class="hint-slot"></span>
                            <input type="text" name="major">
                        </div>
                        <div class="form-group w-1-5">
                            <label>单位名称</label>
                            <span class="hint-slot"></span>
                            <input type="text" name="company">
                        </div>
                        <div class="form-group w-2-5">
                            <label>单位地址</label>
                            <span class="hint-slot"></span>
                            <input type="text" name="company_address">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">培训信息</div>
                <div class="form-grid">
                    <div class="form-group w-xl">
                        <label>作业类别</label>
                        <span class="hint-slot"></span>
                        <select name="job_category" id="job_category" required onchange="updateExamProjectOptions(this)">
                            <option value="">请选择</option>
                        </select>
                    </div>
                    <div class="form-group w-xl">
                        <label>操作项目</label>
                        <span class="hint-slot"></span>
                        <select name="exam_project" id="exam_project" required onchange="updateProjectCode(this)">
                            <option value="">请先选择作业类别</option>
                        </select>
                        <input type="hidden" name="project_code" id="project_code">
                    </div>
                    <div class="form-group w-sm">
                        <label>考试类别</label>
                        <span class="hint-slot"></span>
                        <select name="exam_category" required>
                            <option value="初次领证">初次领证</option>
                            <option value="复审">复审</option>
                            <option value="延期换证">延期换证</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="section-title">证件上传</div>
                <div class="upload-grid">
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">个人照片</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="photo" accept="image/*" required title="请上传个人照片" onchange="previewFile(this)">
                        </div>
                    </div>
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">学历证书</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="diploma" accept="image/*" onchange="previewFile(this)">
                        </div>
                    </div>
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">所持证件正面</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="cert_front" accept="image/*" onchange="previewFile(this)">
                        </div>
                    </div>
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">所持证件反面</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="cert_back" accept="image/*" onchange="previewFile(this)">
                        </div>
                    </div>
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">身份证正面</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="id_card_front" accept="image/*" required title="请上传身份证正面" onchange="previewFile(this)">
                        </div>
                    </div>
                    <div class="form-group w-upload">
                        <div class="upload-box" onclick="this.querySelector('input').click()">
                            <div class="upload-placeholder">
                                <span class="icon">+</span>
                                <span class="text">身份证反面</span>
                            </div>
                            <img class="preview-img" style="display: none;">
                            <input type="file" name="id_card_back" accept="image/*" required title="请上传身份证反面" onchange="previewFile(this)">
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="training_type" id="training_type">
        </div>
    </template>

    <script src="/static/js/constants.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        let jobCategoriesConfig = null;
        
        async function loadJobCategories() {
            try {
                const response = await fetch('/api/config/job_categories');
                if (!response.ok) {
                    throw new Error('Failed to load job categories');
                }
                jobCategoriesConfig = await response.json();
                populateJobCategories();
            } catch (error) {
                console.error('Error loading job categories:', error);
            }
        }
        
        function populateJobCategories() {
            const jobCategorySelects = document.querySelectorAll('select[name="job_category"]');
            jobCategorySelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">请选择</option>';
                
                if (jobCategoriesConfig) {
                    Object.keys(jobCategoriesConfig).forEach(trainingType => {
                        const typeConfig = jobCategoriesConfig[trainingType];
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = typeConfig.name;
                        
                        typeConfig.job_categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.name;
                            option.textContent = category.name;
                            option.dataset.trainingType = trainingType;
                            optgroup.appendChild(option);
                        });
                        
                        select.appendChild(optgroup);
                    });
                }
                
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        function updateExamProjectOptions(categorySelect) {
            const entry = categorySelect.closest('.student-entry');
            const projectSelect = entry.querySelector('select[name="exam_project"]');
            const trainingTypeInput = entry.querySelector('input[name="training_type"]');
            const projectCodeInput = entry.querySelector('input[name="project_code"]');
            const selectedCategory = categorySelect.value;
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            
            projectSelect.innerHTML = '<option value="">请选择操作项目</option>';
            projectCodeInput.value = '';
            
            if (selectedOption && selectedOption.dataset.trainingType) {
                trainingTypeInput.value = selectedOption.dataset.trainingType;
            }
            
            if (selectedCategory && jobCategoriesConfig) {
                let foundProjects = null;
                let foundTrainingType = null;
                
                Object.keys(jobCategoriesConfig).forEach(trainingType => {
                    const typeConfig = jobCategoriesConfig[trainingType];
                    const category = typeConfig.job_categories.find(c => c.name === selectedCategory);
                    if (category) {
                        foundProjects = category.exam_projects;
                        foundTrainingType = trainingType;
                    }
                });
                
                if (foundProjects) {
                    foundProjects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.name;
                        option.textContent = project.code ? `${project.name} (${project.code})` : project.name;
                        option.dataset.code = project.code || '';
                        projectSelect.appendChild(option);
                    });
                }
            }
        }
        
        function updateProjectCode(projectSelect) {
            const entry = projectSelect.closest('.student-entry');
            const projectCodeInput = entry.querySelector('input[name="project_code"]');
            const selectedOption = projectSelect.options[projectSelect.selectedIndex];
            
            if (selectedOption && selectedOption.dataset.code) {
                projectCodeInput.value = selectedOption.dataset.code;
            } else {
                projectCodeInput.value = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadJobCategories();
        });
    </script>
</body>
</html>
