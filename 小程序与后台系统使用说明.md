# 小程序与后台系统使用说明

更新时间：2026-02-26

## 1. 系统概览

本项目由两部分组成：

1. `training-miniprogram`：微信小程序（学员提交、我的提交、审核管理）。
2. `training_system`：网页后台与数据服务（Flask + SQLite）。

当前数据链路：

1. 小程序页面调用云函数。
2. 云函数调用网页后台 API（`/api/students` 等）。
3. 网页后台统一写入 `training_system/database/students.db`。
4. 附件文件由后台保存到 `training_system/students/`。

## 2. 环境准备

## 2.1 网页后台

1. Python 3.9+
2. `pip`

## 2.2 小程序

1. 微信开发者工具
2. 已开通云开发环境
3. 小程序项目已配置 `appid`

## 3. 网页后台启动（training_system）

在项目根目录执行：

```bash
cd training_system
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python app.py
```

启动后访问：

1. 采集页：`http://127.0.0.1:5001/`
2. 管理页：`http://127.0.0.1:5001/admin`

说明：

1. 服务监听地址为 `0.0.0.0:5001`。
2. 数据库在 `training_system/database/students.db`。

## 4. 小程序配置与运行（training-miniprogram）

## 4.1 基础配置

1. 在微信开发者工具导入 `training-miniprogram`。
2. 确认 `app.js` 中 `wx.cloud.init({ env: '...' })` 为你的云环境 ID。
3. 上传并部署全部云函数（云端安装依赖）。

## 4.2 配置网页后台地址（必须）

云函数会从云数据库读取网页后台地址。请在云数据库中配置：

1. 集合：`config`
2. 文档 ID：`origin_system_sync`
3. 文档内容建议：

```json
{
  "base_url": "http://你的后台IP或域名:5001"
}
```

兼容字段也支持：`baseUrl`、`origin_system_base_url`、`originSystemBaseUrl`。

注意：

1. 如果写的是 `http` 地址，必须保证微信云函数网络可访问该地址。
2. 小程序不是直接请求后台，而是云函数请求后台。

## 4.3 管理员权限配置

在云数据库 `admins` 集合新增管理员记录：

1. `openid`: 管理员微信 openid
2. `is_active`: `true`

登录后，管理员会看到“审核管理”标签页。

## 5. 学员端使用流程（小程序）

## 5.1 信息采集

1. 底部点击“信息采集”会强制进入全新采集页（清空编辑状态与表单）。
2. 填写培训信息、基本信息、单位信息并上传附件。
3. 提交后记录进入“待审核（unreviewed）”。

## 5.2 我的提交

1. 仅显示当前用户（按 `openid`）的提交记录。
2. 记录状态：
   - `unreviewed`：待审核，只能查看。
   - `reviewed`：已通过，只能查看。
   - `rejected`：已驳回，可进入编辑并重新提交。
3. 驳回后重新提交会调用更新接口，并将状态回置为 `unreviewed`。

## 6. 审核管理使用流程（小程序管理员）

## 6.1 列表页

1. 支持按审核状态、培训类型、公司筛选。
2. 默认筛选：`待审核 + 特种设备`。
3. 每条记录可执行：
   - 审核通过
   - 驳回
   - 删除
4. 可点击记录进入详情页。

## 6.2 详情页

1. 顶部保留“审核详情”信息。
2. 中间复用信息采集的表单样式（可编辑）。
3. 附件区域支持上传/替换。
4. 按钮：`保存`、`审核通过`、`驳回`。
5. 仅 `unreviewed` 记录可执行通过/驳回；其他状态仅支持保存查看。

## 7. 网页后台使用流程（/admin）

1. 左侧可切换培训类型（特种设备/特种作业）、审核状态（未审核/已审核）、公司筛选。
2. “未审核”查询实际使用 `pending`，会同时包含：
   - `unreviewed`
   - `rejected`（列表会标记“已驳回”）
3. 进入学员详情后：
   - 可编辑信息（自动保存）
   - 可替换附件
   - 可执行审核通过、驳回、删除学员（按当前状态显示可用按钮）

## 8. 状态说明与流转

状态值：

1. `unreviewed`：待审核
2. `reviewed`：已通过
3. `rejected`：已驳回

主要流转：

1. 新建提交：`unreviewed`
2. 审核通过：`reviewed`
3. 驳回：`rejected`
4. 驳回后学员修改重提：`rejected -> unreviewed`
5. 删除：直接删除记录及附件

## 9. 用户区分机制（openid）

1. 小程序提交时，云函数 `submitStudent` 自动写入 `submitter_openid`。
2. “我的提交”查询时，云函数 `getStudents` 会传 `my_only=true` + 当前用户 `openid`。
3. 网页后台数据库通过 `students.submitter_openid` 区分提交人。

## 10. 常见问题排查

## 10.1 提示“未配置原系统地址”

检查云数据库：

1. 集合 `config`
2. 文档 `origin_system_sync`
3. 字段 `base_url` 是否存在且可访问

## 10.2 提示“学员数据不能为空”

调用 `submitStudent` 时未传 `students` 数组或数组为空。检查前端提交参数。

## 10.3 云函数超时

1. 检查网页后台地址是否可达、响应是否过慢。
2. 检查附件体积和网络质量。
3. 在云开发控制台确认云函数超时配置是否过短。

## 10.4 我的提交看到了别人数据

1. 检查后端数据库 `submitter_openid` 是否为空。
2. 检查云函数查询是否传了 `my_only=true` 与当前 `openid`。

## 10.5 状态不是最新

当前标签页切换/返回会自动刷新；仍异常时可下拉刷新一次。

---

如需补充“管理员操作SOP版本（截图版）”或“接口对接说明（API字段级）”，可在此文档基础上继续扩展。
