# 微信小程序培训管理系统 - 完整部署方案

## 一、前置准备

### 1.1 账号注册

**微信小程序账号**
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册小程序账号（企业类型）
3. 完成主体认证（需要营业执照）
4. 获取 AppID（在"开发" -> "开发管理" -> "开发设置"中）

**管理员微信号**
- 记录需要设置为管理员的微信号对应的 openid
- 可以在小程序首次登录后获取

### 1.2 开发工具安装

**微信开发者工具**
1. 下载：[https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 安装并登录（使用管理员微信扫码）
3. 版本要求：最新稳定版

**Node.js 环境**
- 版本要求：Node.js >= 14.x
- 用于云函数开发和部署

---

## 二、项目初始化

### 2.1 创建小程序项目

1. 打开微信开发者工具
2. 点击"+"创建新项目
3. 填写项目信息：
   - 项目名称：培训管理系统
   - 目录：选择空目录
   - AppID：填写你的小程序 AppID
   - 开发模式：小程序
   - 后端服务：微信云开发
   - 模板：不使用模板

### 2.2 初始化云开发环境

1. 在开发者工具中点击"云开发"按钮
2. 开通云开发服务
3. 创建环境：
   - 环境名称：training-prod（生产环境）
   - 环境ID：自动生成（记录下来）
4. 等待环境初始化完成（约2-3分钟）

### 2.3 项目目录结构

创建以下目录结构：

```
training-miniprogram/
├── cloudfunctions/          # 云函数目录
│   ├── login/
│   ├── submitStudent/
│   ├── getStudents/
│   ├── getStudentDetail/
│   ├── reviewStudent/
│   ├── batchReview/
│   ├── exportExcel/
│   ├── generateHealthCheck/
│   ├── downloadAttachments/
│   ├── updateStudent/
│   ├── deleteStudent/
│   └── getCompanies/
├── components/              # 组件目录
│   ├── student-form-item/
│   ├── file-uploader/
│   ├── image-cropper/
│   ├── filter-bar/
│   └── student-card/
├── pages/                   # 页面目录
│   ├── index/
│   ├── user/
│   │   ├── submit/
│   │   ├── list/
│   │   └── detail/
│   └── admin/
│       ├── review/
│       ├── detail/
│       ├── batch/
│       └── export/
├── utils/                   # 工具函数
│   ├── validators.js
│   ├── constants.js
│   └── api.js
├── app.js                   # 全局逻辑
├── app.json                 # 全局配置
├── app.wxss                 # 全局样式
└── project.config.json      # 项目配置
```

---

## 三、云开发配置

### 3.1 配置云开发环境

**修改 app.js**

```javascript
App({
  onLaunch() {
    // 初始化云开发
    wx.cloud.init({
      env: 'training-prod-xxxxx', // 替换为你的环境ID
      traceUser: true
    })

    // 自动登录
    this.login()
  },

  async login() {
    try {
      const { result } = await wx.cloud.callFunction({
        name: 'login'
      })

      this.globalData.userInfo = result
      this.globalData.isAdmin = result.isAdmin

      console.log('登录成功', result)
    } catch (err) {
      console.error('登录失败', err)
      wx.showToast({
        title: '登录失败',
        icon: 'none'
      })
    }
  },

  globalData: {
    userInfo: null,
    isAdmin: false
  }
})
```

**修改 project.config.json**

```json
{
  "miniprogramRoot": "./",
  "cloudfunctionRoot": "cloudfunctions/",
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  },
  "appid": "你的AppID",
  "projectname": "培训管理系统",
  "condition": {}
}
```

### 3.2 创建云数据库集合

1. 在开发者工具中点击"云开发控制台"
2. 进入"数据库"标签
3. 创建以下集合：

**students 集合**
- 集合名称：students
- 权限设置：仅创建者可读写

**admins 集合**
- 集合名称：admins
- 权限设置：所有用户可读，仅管理员可写

**config 集合**
- 集合名称：config
- 权限设置：所有用户可读，仅管理员可写

### 3.3 配置数据库索引

**students 集合索引**

在云开发控制台 -> 数据库 -> students -> 索引管理中添加：

1. 单字段索引：
   - `_openid` (升序)
   - `status` (升序)
   - `training_type` (升序)
   - `company` (升序)
   - `created_at` (降序)

2. 复合索引：
   - `status` (升序) + `training_type` (升序) + `created_at` (降序)

### 3.4 配置数据库权限

在云开发控制台 -> 数据库 -> 权限设置中配置：

**students 集合权限**
```json
{
  "read": "auth.openid != null",
  "write": "auth.openid != null"
}
```

**admins 集合权限**
```json
{
  "read": true,
  "write": false
}
```

**config 集合权限**
```json
{
  "read": true,
  "write": false
}
```

### 3.5 初始化配置数据

**导入作业类别配置**

在云开发控制台 -> 数据库 -> config 集合中，手动添加一条记录：

```json
{
  "_id": "job_categories",
  "data": {
    "special_operation": {
      "name": "特种作业",
      "attachments": ["diploma", "id_card_front", "id_card_back"],
      "job_categories": [
        {
          "name": "电工作业",
          "exam_projects": [
            {"name": "低压电工作业", "code": ""},
            {"name": "高压电工作业", "code": ""},
            {"name": "电力电缆作业", "code": ""},
            {"name": "电气试验作业", "code": ""},
            {"name": "继电保护作业", "code": ""},
            {"name": "防爆电气作业", "code": ""}
          ]
        },
        {
          "name": "焊接与热切割作业",
          "exam_projects": [
            {"name": "熔化焊接与热切割作业", "code": ""}
          ]
        },
        {
          "name": "高处作业",
          "exam_projects": [
            {"name": "登高架设作业", "code": ""},
            {"name": "高处安装、维护、拆除作业", "code": ""}
          ]
        }
      ]
    },
    "special_equipment": {
      "name": "特种设备",
      "attachments": ["photo", "diploma", "id_card_front", "id_card_back", "hukou_residence", "hukou_personal"],
      "job_categories": [
        {
          "name": "特种设备安全管理",
          "exam_projects": [
            {"name": "电梯管理", "code": "A"},
            {"name": "场（厂）内专用机动车辆安全管理", "code": "A"},
            {"name": "起重机械管理", "code": "A"},
            {"name": "锅炉压力容器压力管道", "code": "A"},
            {"name": "特种设备安全管理", "code": "A"}
          ]
        },
        {
          "name": "锅炉作业",
          "exam_projects": [
            {"name": "工业锅炉司炉", "code": "G1"},
            {"name": "锅炉水处理", "code": "G3"}
          ]
        },
        {
          "name": "压力容器作业",
          "exam_projects": [
            {"name": "快开门式压力容器操作", "code": "R1"}
          ]
        },
        {
          "name": "起重机作业",
          "exam_projects": [
            {"name": "起重机指挥", "code": "Q1"},
            {"name": "桥式起重机司机", "code": "Q2"}
          ]
        },
        {
          "name": "场(厂)内专用机动车辆作业",
          "exam_projects": [
            {"name": "叉车司机", "code": "N1"},
            {"name": "观光车和观光列车司机", "code": "N2"}
          ]
        }
      ]
    }
  },
  "updated_at": new Date()
}
```

**添加管理员账号**

在 admins 集合中手动添加管理员记录：

```json
{
  "openid": "管理员的openid",
  "name": "管理员姓名",
  "role": "admin",
  "created_at": new Date(),
  "is_active": true
}
```

注意：openid 需要在管理员首次登录小程序后获取。

---

## 四、云函数部署

### 4.1 云函数开发

每个云函数的基本结构：

```
cloudfunctions/login/
├── index.js          # 云函数入口
├── package.json      # 依赖配置
└── config.json       # 云函数配置（可选）
```

### 4.2 安装云函数依赖

对于需要 npm 包的云函数（如 exportExcel、generateHealthCheck），需要安装依赖：

1. 右键点击云函数目录
2. 选择"在终端中打开"
3. 运行 `npm install`

**exportExcel 依赖**
```bash
cd cloudfunctions/exportExcel
npm install node-xlsx
```

**generateHealthCheck 依赖**
```bash
cd cloudfunctions/generateHealthCheck
npm install docxtemplater pizzip
```

**downloadAttachments 依赖**
```bash
cd cloudfunctions/downloadAttachments
npm install jszip
```

### 4.3 部署云函数

**方式一：单个部署**
1. 右键点击云函数目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

**方式二：批量部署**
1. 右键点击 cloudfunctions 目录
2. 选择"上传并部署：云端安装依赖（全部云函数）"
3. 等待所有云函数部署完成

### 4.4 验证云函数

在云开发控制台 -> 云函数中查看：
- 所有云函数状态为"部署成功"
- 可以点击"测试"按钮测试云函数

---

## 五、云存储配置

### 5.1 创建存储目录

在云开发控制台 -> 云存储中创建以下目录：

```
/students/
  /special_operation/
  /special_equipment/
/exports/
/temp/
/templates/
```

### 5.2 上传模板文件

将体检表模板上传到 `/templates/` 目录：
- 叉车司机体检表.docx
- 锅炉水处理体检表.docx

### 5.3 配置存储权限

在云开发控制台 -> 云存储 -> 权限设置：
- 所有用户可读
- 仅创建者可写

---

## 六、小程序代码部署

### 6.1 开发阶段

1. 在微信开发者工具中编写代码
2. 使用"编译"按钮预览效果
3. 使用"真机调试"在手机上测试

### 6.2 体验版发布

1. 点击"上传"按钮
2. 填写版本号和项目备注
3. 上传成功后，在微信公众平台查看
4. 设置体验版，邀请测试人员

### 6.3 提交审核

1. 登录微信公众平台
2. 进入"版本管理"
3. 选择要提交的版本
4. 填写审核信息：
   - 功能页面：选择主要功能页面
   - 测试账号：提供测试账号（如需要）
   - 补充说明：说明小程序功能
5. 提交审核（通常1-7天）

### 6.4 正式发布

1. 审核通过后，在"版本管理"中点击"发布"
2. 确认发布
3. 发布成功后，用户可以搜索到小程序

---

## 七、配置管理员

### 7.1 获取管理员 openid

**方法一：临时调试页面**

创建一个临时页面显示 openid：

```javascript
// pages/debug/debug.js
Page({
  async onLoad() {
    const { result } = await wx.cloud.callFunction({
      name: 'login'
    })
    console.log('当前用户 openid:', result.openid)
    this.setData({
      openid: result.openid
    })
  }
})
```

**方法二：云函数日志**

在 login 云函数中打印 openid，然后在云开发控制台查看日志。

### 7.2 添加管理员到数据库

1. 获取管理员的 openid
2. 在云开发控制台 -> 数据库 -> admins 集合中添加记录：

```json
{
  "openid": "oXXXX-管理员的openid",
  "name": "张三",
  "role": "admin",
  "created_at": { "$date": "2026-02-25T00:00:00.000Z" },
  "is_active": true
}
```

3. 保存后，该用户即可使用管理员功能

---

## 八、测试验证

### 8.1 功能测试清单

**普通用户功能**
- [ ] 微信登录成功
- [ ] 选择培训类型
- [ ] 填写单个学员信息
- [ ] 添加多个学员
- [ ] 上传附件（各种类型）
- [ ] 照片裁剪功能
- [ ] 表单验证（身份证、手机号）
- [ ] 提交成功
- [ ] 查看提交记录
- [ ] 查看提交详情

**管理员功能**
- [ ] 管理员登录成功
- [ ] 查看学员列表
- [ ] 按状态筛选
- [ ] 按培训类型筛选
- [ ] 按公司筛选
- [ ] 搜索学员
- [ ] 查看学员详情
- [ ] 预览附件
- [ ] 审核通过
- [ ] 审核驳回
- [ ] 批量审核
- [ ] 导出 Excel
- [ ] 下载附件压缩包
- [ ] 生成体检表

### 8.2 性能测试

- [ ] 列表分页加载正常
- [ ] 图片上传速度可接受
- [ ] 大文件上传不超时
- [ ] 批量操作响应及时

### 8.3 权限测试

- [ ] 普通用户无法访问管理员页面
- [ ] 普通用户只能看到自己的提交
- [ ] 管理员可以看到所有提交
- [ ] 未登录用户无法访问任何功能

---

## 九、监控和维护

### 9.1 云开发监控

在云开发控制台查看：
- **云函数调用统计**：监控调用次数和错误率
- **数据库统计**：监控读写次数
- **云存储统计**：监控存储空间使用
- **日志查询**：查看错误日志

### 9.2 小程序数据分析

在微信公众平台 -> 数据分析中查看：
- 用户访问数据
- 页面访问路径
- 用户留存率
- 错误日志

### 9.3 定期维护

**每周**
- 检查云函数错误日志
- 清理临时文件（/temp/ 和 /exports/）
- 检查数据库性能

**每月**
- 检查云开发资源使用情况
- 优化慢查询
- 备份重要数据

**按需**
- 更新云函数代码
- 优化小程序性能
- 添加新功能

---

## 十、常见问题

### 10.1 云函数调用失败

**问题**：云函数返回 -1 错误

**解决方案**：
1. 检查云函数是否部署成功
2. 检查云函数权限配置
3. 查看云函数日志排查错误

### 10.2 文件上传失败

**问题**：文件上传超时或失败

**解决方案**：
1. 检查文件大小是否超过限制（10MB）
2. 检查网络连接
3. 检查云存储权限配置

### 10.3 数据库查询慢

**问题**：学员列表加载缓慢

**解决方案**：
1. 检查是否创建了索引
2. 优化查询条件
3. 减少单次查询数量（分页）

### 10.4 管理员权限不生效

**问题**：管理员无法访问管理功能

**解决方案**：
1. 检查 admins 集合中是否有该用户记录
2. 检查 openid 是否正确
3. 检查 is_active 字段是否为 true
4. 重新登录小程序

---

## 十一、成本估算

### 11.1 云开发资源

**免费额度**（每月）：
- 云函数调用：100万次
- 数据库读操作：5万次
- 数据库写操作：3万次
- 云存储容量：5GB
- 云存储下载流量：5GB

**预估使用**（100个活跃用户/月）：
- 云函数调用：约 5万次
- 数据库操作：约 2万次
- 云存储：约 2GB
- 完全在免费额度内

### 11.2 小程序认证费用

- 企业认证：300元/年
- 个人小程序：免费（功能受限）

---

## 十二、部署检查清单

部署前请确认以下事项：

**账号准备**
- [ ] 已注册微信小程序账号
- [ ] 已完成企业认证
- [ ] 已获取 AppID

**开发环境**
- [ ] 已安装微信开发者工具
- [ ] 已安装 Node.js
- [ ] 已开通云开发环境

**云开发配置**
- [ ] 已创建 students、admins、config 集合
- [ ] 已配置数据库索引
- [ ] 已配置数据库权限
- [ ] 已导入配置数据
- [ ] 已创建云存储目录
- [ ] 已上传模板文件

**云函数部署**
- [ ] 所有云函数已部署成功
- [ ] 云函数依赖已安装
- [ ] 云函数测试通过

**小程序代码**
- [ ] app.js 中环境ID已配置
- [ ] 所有页面已开发完成
- [ ] 所有组件已开发完成
- [ ] 本地测试通过
- [ ] 真机测试通过

**管理员配置**
- [ ] 已获取管理员 openid
- [ ] 已添加管理员到 admins 集合
- [ ] 管理员权限测试通过

**上线准备**
- [ ] 已上传体验版
- [ ] 体验版测试通过
- [ ] 已提交审核
- [ ] 审核通过
- [ ] 已正式发布

---

## 十三、技术支持

**微信官方文档**
- 小程序开发文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- 云开发文档：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html

**社区支持**
- 微信开放社区：https://developers.weixin.qq.com/community/minihome
- Stack Overflow：搜索 "wechat miniprogram"

**联系方式**
- 如有问题，请联系开发团队

---

## 附录：快速部署命令

```bash
# 1. 创建项目目录
mkdir training-miniprogram
cd training-miniprogram

# 2. 初始化 npm（如果需要）
npm init -y

# 3. 安装云函数依赖
cd cloudfunctions/exportExcel && npm install node-xlsx && cd ../..
cd cloudfunctions/generateHealthCheck && npm install docxtemplater pizzip && cd ../..
cd cloudfunctions/downloadAttachments && npm install jszip && cd ../..

# 4. 部署完成后，在微信开发者工具中：
# - 上传云函数
# - 编译小程序
# - 上传代码
# - 提交审核
```

---

**部署完成！** 🎉

按照以上步骤，你的微信小程序培训管理系统就可以成功部署上线了。
